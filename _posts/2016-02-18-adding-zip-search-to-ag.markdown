---
layout: post
title: "Adding zip search to ag"
date: "2016-02-18 10:50:42 +0100"
codebase: https://github.com/jschpp/the_silver_searcher/tree/d999d23ca5c7a7300173fe472ec57d5cbb85cc8a
---
First of all kudos to @ggreer I really like `ag`. My problem was searching zip compressed folders with it.

The issue I'm trying to fix is [#743 Implement searching in zip-files][743].

As stated there I needed to decide how to process zip files or to be more specific, how to handle zip folder structures. A zip file with the following structure could've been easily handled with the existing API:

    file.zip
    |-- file.txt

A file looking like this couldn't:

    file.zip
    |-- file.txt
    |-- folder/
        |-- file2.txt

At this point I wanted input how to proceed but zip processing isn't that important. Import for @ggreer was primary the correct implementation of ignore files as stated in his [blog][ag-1.0].

I decided to break the API in terms of implementing a `process_zip()` method which handles parsing a zip file and passing all files (not folders) within this file to `search_buf()`.

At first I began writing the method and it worked... On my system... only. I realized this when opening my first pull request [pr #840][#840].

# Problems
- I need `libzip` version 1.0 or greater
- I need to add this version of `libzip` to travis

Adding the requirement of version 1.0 wasn't that hard to do. Adding

    PKG_CHECK_MODULES([LIBZIP], [libzip >= 1.0])

to `configure.ac` was enough to the `ag` that the standard installation of v0.11 isn't working.

Adding libzip-1.0 to travis was a tad bit more annoying -.-

Trying to install `libzip-dev` yielded said version 0.11 of libzip. Trying to do a manual install brought forth a couple of minor hurdles (most of them were generated by me not RTFMing -.-'). Heres what not to do:

- adding the pre install `./configure && make &&make install` at the wrong point in the tarvis.yml [1][1]
- not compiling the correct branch (all commits before [2][2])
- not working in the right dir [3][3] & [4][4]
- but __most__ importantly spamming @ggreer with every commit I made at 1 a.m. until [5][5] That even resulted in a commit by him removing notifications in his repo [6][6]

So after managing to do all of the above points my travis config looks like this:
{% highlight yaml %}
language: c

branches:
  only:
    - master
    - zip

compiler:
  - clang
  - gcc

before_install:
  - sudo add-apt-repository -y 'ppa:ubuntu-toolchain-r/test'
  - sudo add-apt-repository -y 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.6 main'
  - curl http://llvm.org/apt/llvm-snapshot.gpg.key | sudo apt-key add -
  - sudo apt-get update -q
  - sudo apt-get install -q -y automake pkg-config libpcre3-dev zlib1g-dev liblzma-dev
  - sudo apt-get install -y clang-format-3.6

before_script:
  - sudo pip install cram
  - wget http://nih.at/libzip/libzip-1.1.1.tar.gz -O /tmp/libzip-1.1.1.tar.gz
  - pushd /tmp
  - tar -xvf /tmp/libzip-1.1.1.tar.gz
  - cd libzip-1.1.1
  - ./configure --prefix=/usr && make && sudo make install
  - popd

script:
  - ./build.sh && make test
{% endhighlight %}

[ag-1.0]: http://geoff.greer.fm/2014/10/13/help-me-get-to-ag-10/
[743]: https://github.com/ggreer/the_silver_searcher/issues/743
[#840]: https://github.com/ggreer/the_silver_searcher/pull/840
[1]: https://github.com/jschpp/the_silver_searcher/commit/81bab54483f0cd29c482d2266bc73b5fbd76e10c
[2]: https://github.com/jschpp/the_silver_searcher/commit/1b0cd2d1040a06ff008a06ae6a1e841ea0925137
[3]: https://github.com/jschpp/the_silver_searcher/commit/5be27a9599d01746df5dcc8c6547e3835d674986
[4]: https://github.com/jschpp/the_silver_searcher/commit/e3ee6007e7eec387800a96c3c3e6877e82737731
[5]: https://github.com/jschpp/the_silver_searcher/commit/55a138a2e3c92b4d57125bc40f9e6405b40f4028
[6]: https://github.com/ggreer/the_silver_searcher/commit/f4bb889c98077d57e44b5d992ea4043c2836d3e8
